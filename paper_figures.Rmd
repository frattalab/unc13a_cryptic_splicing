---
title: "Figures for Paper"
author: "Anna-Leigh Brown"
date: "06/10/2020"
output: 
    html_document:
        code_folding: hide
        toc: true
        toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE)
if (!require("pacman")) install.packages("pacman")
library(pacman)
p_load("data.table",
       "tidyverse",
       "ggplot2",
       "rcompanion",
       "lme4",
       "ggpubr",
       "forcats",
       "scales",
       "here",
       "ggthemes",
       "ggrepel")
```


# iPSC splicing

Read in the splicing results returned by MAJIQ and make a volcano plot, only highlight 
genes of interest with a label.

```{r}
junc_colors = c("#648FFF","#fe6101")
ipsc_splicing = fread(file.path(here::here(),"data","ipsc_splicing_results.csv"))
ipsc_de = fread(file.path(here::here(),"data","ipsc_differential_expression.csv"))


ipsc_splicing %>% 
  mutate(junction_name = case_when(gene_name %in% c("UNC13A","AGRN",
                                                     "UNC13B","PFKP","SETD5",
                                                     "ATG4B","STMN2") & 
                                      p_d_psi_0_10_per_lsv_junction > 0.9  & 
                                      deltaPSI > 0 ~ gene_name,
                                    T ~ "")) %>% 
  mutate(junction_name = make.unique(junction_name,sep = ".")) %>% 
  mutate(`Novel Junction` = de_novo_junctions == 0) %>% 
  mutate(log10_test_stat = -log10(1 - p_d_psi_0_10_per_lsv_junction)) %>% 
  mutate(log10_test_stat = ifelse(is.infinite(log10_test_stat), 16, log10_test_stat)) %>% 
  mutate(graph_alpha = ifelse(p_d_psi_0_10_per_lsv_junction > 0.9, 1, 0.2)) %>% 
  mutate(label_junction = case_when(gene_name %in% c("UNC13A","AGRN",
                                                     "UNC13B","PFKP","SETD5",
                                                     "ATG4B","STMN2") & 
                                      p_d_psi_0_10_per_lsv_junction > 0.9  & 
                                      deltaPSI > 0 ~ junction_name,
                                    T ~ "")) %>% 
  ggplot(aes(x = deltaPSI, y = log10_test_stat)) +
  geom_point(aes(fill = `Novel Junction`,alpha = graph_alpha), pch = 21, size = 4) + 
  geom_text_repel(aes(label = label_junction), point.padding = 0.3,
                  min.segment.length = unit(0, 'lines')) +
  geom_hline(yintercept = -log10(1 - .9)) + 
  guides(alpha = FALSE, size = FALSE) + 
  scale_fill_manual(values = junc_colors) + 
  theme(legend.position = 'top') + 
  ggpubr::theme_pubr() + 
  xlab("delta PSI") + 
  ylab("-Log 10 Test Statistic") + 
  theme(text = element_text(size = 18))
```



# UNC13A Cryptic PSI across TDP-43 KD experiments

We have 2 PSI's for the UNC13A cryptic, one which includes both the short and
long form of the cryptic, and one which does not. While we're not mentioning in 
figure 1, given that the longer form of the cryptic appears in control cerebellum, 
one could argue that that junction should not be included in the PSI calculation
here for UNC13A cryptic per se. In practice, this makes very little difference in the
conclusions made on the cell lines, so I've included both for completeness.

The 'C/G' tells which genotypes were supported by RNA-seq on rs12973192. 
The NB cell lines are het, as is the WTC11 cell line. SH-SY5Y cells are homozygote for the major allele. 
There was variability on the Klim hMN set on allelic expression. 
```{r}


rel_rna_cryptic_amount = data.table::fread(file.path(here::here(),"data","kd_experiments_relative_rna_and_unc13a_cryptic_junction_counts.csv"))
rel_rna_cryptic_amount[,cryptic_psi_full := ( UNC13A_3prime + 
                                          UNC13A_5prime +  UNC13A_5prime_2 + 
                                          UNC13A_5prime_3) / (UNC13A_annotated +  UNC13A_3prime + 
                                          UNC13A_5prime +  UNC13A_5prime_2 + 
                                          UNC13A_5prime_3)]
rel_rna_cryptic_amount %>% 
    ggbarplot(,
              x = "source",
              add = c("mean_se","jitter"),
              y = "cryptic_psi_full",
              fill = 'condition',
              color = 'condition',
              position = position_dodge(0.8)) + 
    ggpubr::theme_pubr() +
    scale_fill_manual(
        values = c("#40B0A6","#E1BE6A")
    ) + 
    scale_color_manual(
        values = c("#1C2617","#262114")
    ) +
    ylab("UNC13A Cryptic PSI") + 
    xlab("") + 
    guides(color = FALSE) 

unca = rel_rna_cryptic_amount %>% 
  ggbarplot(,
            x = "source",
            add = c("mean_se","jitter"),
            y = "cryptic_psi",
            fill = 'condition',
            color = 'condition',
            position = position_dodge(0.8)) + 
  ggpubr::theme_pubr() +
  scale_fill_manual(
      values = c("#40B0A6","#E1BE6A")
  ) + 
  scale_color_manual(
      values = c("#1C2617","#262114")
  ) +
  ylab("UNC13A Cryptic PSI") + 
  xlab("") + 
  guides(color = FALSE) 

stmn2 = rel_rna_cryptic_amount %>% 
  ggbarplot(,
            x = "source",
            add = c("mean_se","jitter"),
            y = "stmn_2_cryptic_psi",
            fill = 'condition',
            color = 'condition',
            position = position_dodge(0.8)) + 
  ggpubr::theme_pubr() +
  scale_fill_manual(
      values = c("#40B0A6","#E1BE6A")
  ) + 
  scale_color_manual(
      values = c("#1C2617","#262114")
  ) +
  ylab("STMN2 Cryptic PSI") + 
  xlab("") + 
  guides(color = FALSE)

rel_rna_cryptic_amount %>% 
    ggbarplot(,
              x = "source",
              add = c("mean_se","jitter"),
              y = "normalized_unc13b_ir",
              fill = 'condition',
              color = 'condition',
              position = position_dodge(0.8)) + 
    ggpubr::theme_pubr() +
    scale_fill_manual(
        values = c("#40B0A6","#E1BE6A")
    ) + 
    scale_color_manual(
        values = c("#1C2617","#262114")
    ) +
    ylab("UNC13B Intron Retention Ratio") + 
    xlab("") + 
    guides(color = FALSE)

rel_rna_cryptic_amount %>% 
    ggbarplot(,
              x = "source",
              add = c("mean_se","jitter"),
              y = "normalized_unc13a_ir",
              fill = 'condition',
              color = 'condition',
              position = position_dodge(0.8)) + 
    ggpubr::theme_pubr() +
    scale_fill_manual(
        values = c("#40B0A6","#E1BE6A")
    ) + 
    scale_color_manual(
        values = c("#1C2617","#262114")
    ) +
    scale_x_discrete(labels=c("shsy5y_normed" = "NB cells \n C/G", 
                              "ipsc_normed_ward" = "iPSC Neurons \n C/G",
                              "shsy5y_normed_no_snp" = "SH-SY5Y \n C/C",
                              "klim_normed" = "Klim iPSC MN \n C/G + C/C",
                              "sh_dzap" = "Appocher \n NB cells \n C/G")) +
    ylab("UNC13A Intron Retention Ratio") + 
    xlab("") + 
    guides(color = FALSE)

rel_rna_cryptic_amount %>% 
    filter(condition != "control") %>% 
    ggplot() + 
    geom_point(aes(x = TARDBP, y = normalized_unc13b_ir, fill = source),pch = 21,size = 4) + 
    stat_cor(aes(x = TARDBP, y = normalized_unc13b_ir)) +
    theme(legend.position = 'bottom')
ggarrange(unca,stmn2)
```

# Paient summary statistics
First let's look at only including tissues with detectable stmn2 or UNC13A CE
```{r}
clean_data_table = fread(file.path(here::here(),"data","nygc_junction_information.csv"))
clean_data_table = clean_data_table %>%     
    mutate(call = fct_relevel(call,
                              "C/C", "C/G", "G/G")) %>% 
    mutate(number_g_alleles = as.numeric(call) - 1) %>% 
    mutate(unc13a_cryptic_leaf_psi = ifelse(is.na(unc13a_cryptic_leaf_psi),0,unc13a_cryptic_leaf_psi)) %>% 
    mutate(stmn2_psi_groups = as.numeric(cut_interval(log10(stmn_2_cryptic_psi_leaf), n = 2))) %>%
    mutate(stmn2_psi_groups = case_when(stmn2_psi_groups == 1 ~ " Low STMN2",
                                      stmn2_psi_groups == 2 ~ "High STMN2",
                                      TRUE ~ "No STMN2"))

print(glue::glue("Number of unique patients: {clean_data_table[,length(unique(participant_id))]}"))
print(glue::glue("Number of unique tissue samples: {clean_data_table[,length(unique(sample))]}"))
print("Patients Per Disease Category")
clean_data_table[,length(unique(participant_id)),by = disease]
print("Tissues Per Disease Category")
clean_data_table[,length(unique(sample)),by = disease]
print("Number of patients per rs12973192 genotype")
clean_data_table[,length(unique(participant_id)),by = call]
print("Number of tissues per disease")
clean_data_table[,.N,by = c("disease","tissue_clean")]
print("Number of partcipants by mutation and  disease")
clean_data_table[,length(unique(participant_id)),by = c("mutations","disease")]

print(glue::glue("Number of patients per pathology:"))
clean_data_table[,length(unique(participant_id)),by = .(pathology)]
```
# UNC13A cryptic is an event that is specific to TDP-43 proteinopathy

FTLD-non-TDP are those with TAU and FUS aggregates

Non-tdp ALS are those with SOD1 or FUS mutations. The n's are quite low on this 
unfortunately, only 8 ALS with SOD1 and 2 with FUS mutations.  

First we look at detection rate in tissues affected by TDP-43 proteinopathy,
For FTLD this is frontal and temporal Cortices, and
for ALS this is lumbar, cervical, and thoracic spinal cord samples as well as 
motor cortex. For controls we also take all 6 tissues, 
frontal,temporal,motor cortices and the lumbar, cervical, and thoracic spinal cords. 

(As a side note, once we do this the number of ALS-non-TDP drops down to 6 (2 FUS) because
the ALS sample tissues are not balanced and not every participant has samples in every tissue)
```{r}
####Inclusion reads by if TDP-potential####
boxplot_table = clean_data_table %>% 
    mutate(disease_group2 = case_when(disease == "Control" ~ "Control",
                                 pathology %in% c("FTD-TDP-A","FTD-TDP-B","FTD-TDP-C") ~ "FTLD-TDP",
                                 pathology %in% c("FTD-TAU","FTD-FUS") ~ "FTLD \n non-TDP",
                                 mutations %in% c("SOD1","FUS") ~ "ALS \n non-TDP",
                                 T ~ "ALS-TDP")) %>% 
    mutate(across(UNC13A_3prime_leaf:UNC13A_annotated_leaf, ~ .x / library_size,.names = "{.col}_library_norm")) %>% 
    filter(!tissue_clean %in% c("Choroid","Liver")) %>% 
    dplyr::select(sample,participant_id,mutations,disease_group2,pathology,tissue_clean,contains("_library_norm")) %>% 
    melt() %>% 
    filter(grepl("_3prime|_5prime_",variable)) %>% 
    group_by(sample) %>% 
    mutate(inclusion_reads = sum(value)) %>% 
    ungroup() %>% 
    unique() %>% 
    mutate(junction_name = case_when(variable == "UNC13A_3prime_leaf_library_norm" ~ "  Novel 3'", 
                                 variable == "UNC13A_5prime_1_leaf_library_norm" ~ " Short Novel 5'", 
                                 variable == "UNC13A_5prime_2_leaf_library_norm"~ "Long Novel 5'")) %>% 
    mutate(disease_tissue = case_when((grepl("FTLD",disease_group2) & grepl("Cortex",tissue_clean))  ~ T,
                                      (grepl("ALS",disease_group2) & grepl("Cord|Motor",tissue_clean))  ~ T,
                                      (grepl("Occipital",tissue_clean)) ~ F,
                                      (grepl("Control",disease_group2) & grepl("Cord|Cortex",tissue_clean)) ~ T,
           TRUE ~ F)) %>% 
    mutate(tissue_clean = gsub("_"," ",tissue_clean))

melt_count = clean_data_table[,.(sample,UNC13A_3prime_leaf,UNC13A_5prime_1_leaf,UNC13A_5prime_2_leaf)] %>% data.table::melt() %>% setnames(.,"value","orig_count")
```

Looking at disease tissue only, so just taking the cords in ALS and the 
frontal and temporal cortex of FTLD and then the cord and cortices in Controls.
```{r}

boxplot_table %>% 
  filter(disease_tissue == T) %>% 
  mutate(detected = inclusion_reads > 0) %>% 
  dplyr::select(participant_id,disease_group2,detected) %>% 
  unique() %>% 
  group_by(disease_group2) %>% 
  mutate(n_sample = n_distinct(participant_id)) %>% 
  mutate(n_sample_detected = sum(detected)) %>% 
  dplyr::select(disease_group2,n_sample,n_sample_detected) %>% 
  unique() %>% 
  mutate(detection_rate = n_sample_detected / n_sample) %>% 
  mutate(disease_group2 = gsub("Control"," Control",disease_group2)) %>% 
  mutate(detection_name = glue::glue("{disease_group2} \n ( {n_sample} )")) %>% 
  ggplot() +
  geom_col(aes(x = detection_name, y = detection_rate)) + 
  ggpubr::theme_pubr() + 
  scale_y_continuous(lim = c(0,1),labels = scales::percent) + 
  ylab("Percent of Patients \n UNC13A Cryptic Detected") + 
  theme(text = element_text(size = 18)) + 
  xlab("N individuals")
```


# Detection UNC13A by tissue

```{r}
boxplot_table %>% 
  filter(disease_tissue == T) %>% 
  mutate(detected = inclusion_reads > 0) %>% 
  dplyr::select(participant_id,disease_group2,detected,tissue_clean) %>% 
  unique() %>% 
  group_by(disease_group2,tissue_clean) %>% 
  mutate(n_sample = n_distinct(participant_id)) %>% 
  mutate(n_sample_detected = sum(detected)) %>% 
  dplyr::select(tissue_clean,disease_group2,n_sample,n_sample_detected) %>% 
  unique() %>% 
  mutate(detection_rate = n_sample_detected / n_sample) %>% 
  mutate(disease_group2 = gsub("Control"," Control",disease_group2)) %>% 
  mutate(detection_name = glue::glue("{disease_group2} \n {tissue_clean} \n ( {n_sample} )")) %>% 
  ggplot() +
  geom_col(aes(x = disease_group2, y = detection_rate)) + 
  ggpubr::theme_pubr() + 
  scale_y_continuous(lim = c(0,1),labels = scales::percent) + 
  ylab("Percent of Patients \n UNC13A Cryptic Detected") + 
  theme(text = element_text(size = 18)) + 
  xlab("N individuals") + 
  facet_wrap(~tissue_clean) +
  theme(axis.text.x =  element_text(size = 14)) + 
      theme_bw() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  theme(text = element_text(size = 18))  
```

# Detection UNC13A by tissue and Genotype

```{r}
boxplot_table %>% 
  filter(disease_tissue == T) %>% 
  mutate(detected = inclusion_reads > 0) %>% 
  dplyr::select(participant_id,disease_group2,detected,tissue_clean) %>% 
  left_join(clean_data_table %>% dplyr::select(participant_id,call)) %>% 
  unique() %>% 
  group_by(disease_group2,tissue_clean,call) %>% 
  mutate(n_sample = n_distinct(participant_id)) %>% 
  mutate(n_sample_detected = sum(detected)) %>% 
  dplyr::select(tissue_clean,disease_group2,n_sample,n_sample_detected) %>% 
  unique() %>% 
  mutate(detection_rate = n_sample_detected / n_sample) %>% 
  mutate(disease_group2 = gsub("Control"," Control",disease_group2)) %>% 
  ggplot() +
  geom_col(aes(x = disease_group2, y = detection_rate,fill = call),position = "dodge") + 
  ggpubr::theme_pubr() + 
  scale_y_continuous(lim = c(0,1),labels = scales::percent) + 
  ylab("Percent of Patients \n UNC13A Cryptic Detected") + 
  theme(text = element_text(size = 18)) + 
  xlab("N individuals") + 
  facet_wrap(~tissue_clean) +
  theme(axis.text.x =  element_text(size = 14)) + 
      theme_bw() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  theme(text = element_text(size = 18))  
```



```{r}




disease_comparisons = list( c("Control","ALS-TDP"),
                           c("Control","ALS \n non-TDP"),
                           c("Control","FTLD-TDP"),
                           c("Control","FTLD \n non-TDP" ))

table_to_test = boxplot_table %>% 
    filter(disease_tissue == T) %>% 
    group_by(disease_group2) %>% 
    mutate(n_sample = n_distinct(sample)) %>% 
    mutate(disease_group2 = gsub("Control"," Control",disease_group2)) %>% 
    mutate(detection_name = glue::glue("{disease_group2} \n ( {n_sample} )")) %>% 
    dplyr::select(detection_name,
                  participant_id,
                  inclusion_reads,
                  disease_group2) %>% 
    unique() 

test_pair = pairwise.wilcox.test(table_to_test$inclusion_reads, table_to_test$detection_name,
                     p.adjust.method = "BH") %>% broom::tidy()

test_pair = test_pair %>% 
  mutate(p_value_draw = case_when(p.value < 0.0001~ "***",
                                  p.value < 0.01 ~ "**",
                                   p.value < 0.05 ~ "*",
                          TRUE ~ paste0("Adj. p-value \n",as.character(round(p.value,2))))) %>% 
  mutate(y.position = seq(0.25,by = 0.1,length.out = 9))

table_to_test %>% 
    ggplot(aes(x = detection_name, y = inclusion_reads * 10^6)) + 
    geom_boxplot() + 
    geom_jitter(height = 0) + 
    scale_y_log10() + 
    ggpubr::theme_pubr() +
    ylab("UNC13A cryptic inclusion \n reads per million") + 
    theme(text = element_text(size = 18)) + 
    xlab("N samples") + 
    stat_pvalue_manual(test_pair %>% filter(p.value < 0.05),
                       label = "p_value_draw") +
   stat_compare_means()


####Inclusion reads by if TDP-potential####
boxplot_table %>% 
  filter(disease_group2 %in% c("Control",
                              "FTLD \n non-TDP",
                              "FTLD-TDP")) %>% 
    filter(tissue_clean %in% c("Cerebellum","Frontal Cortex","Temporal Cortex")) %>% 
  dplyr::select(disease_group2,
                tissue_clean,
                junction_name,
                value) %>% 
  unique() %>% 
    ggplot(aes(x = disease_group2, 
               y = value * 10^6,
               fill = junction_name)) + 
    geom_boxplot(show.legend = F) + 
    geom_jitter(height = 0,show.legend = F) + 
    scale_y_log10() + 
    ggpubr::theme_pubr() +
    facet_grid(vars(junction_name),vars(tissue_clean)) + 
    ylab("UNC13A cryptic \n reads per million") +
    xlab("") +
    theme_bw() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
      theme(text = element_text(size = 18))  

      


```

Splitting by the type of junction in ALS
```{r}
####Inclusion reads by if TDP-potential####
boxplot_table %>% 
  filter(disease_group2 %in% c("Control",
                              "ALS \n non-TDP",
                              "ALS-TDP")) %>% 
      filter(tissue_clean %in% c("Cerebellum","Motor Cortex","Temporal Cortex") | grepl("Cord",tissue_clean)) %>% 
  dplyr::select(disease_group2,
                tissue_clean,
                junction_name,
                value) %>% 
  unique() %>% 
  mutate(disease_group2 = fct_relevel(disease_group2,"Control","ALS \n non-TDP","ALS-TDP")) %>% 
    ggplot(aes(x = disease_group2, 
               y = value * 10^6,
               fill = junction_name)) + 
    geom_boxplot(show.legend = F) + 
    geom_jitter(height = 0,show.legend = F) + 
    scale_y_log10() + 
    ggpubr::theme_pubr() +
    facet_grid(vars(junction_name),vars(tissue_clean)) + 
    ylab("UNC13A cryptic \n reads per million") +
    xlab("") +
    scale_fill_manual(values = colorblind_pal()(4)[2:4]) +
  theme(axis.text.x =  element_text(size = 14)) + 
      theme_bw() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  theme(text = element_text(size = 18))  
```

```{r}
clean_data_table %>% 
    mutate(disease_group2 = case_when(disease == "Control" ~ "Control",
                                 pathology %in% c("FTD-TDP-A","FTD-TDP-B","FTD-TDP-C") ~ "FTLD-TDP",
                                 pathology %in% c("FTLD-TAU","FTLD-FUS") ~ "FTLD-non-TDP",
                                 mutations %in% c("SOD1","FUS") ~ "ALS \n non-TDP",
                                 T ~ "ALS-TDP")) %>% 
    filter(disease_group2 %in% c("ALS \n non-TDP","ALS-TDP")) %>% 
    mutate(across(UNC13A_3prime_leaf:UNC13A_annotated_leaf, ~ .x / library_size,.names = "{.col}_library_norm")) %>% 
    filter(!tissue_clean %in% c("Choroid","Liver")) %>% 
    dplyr::select(sample,disease_group2,tissue_clean,contains("_library_norm")) %>% 
    melt() %>% 
    filter(grepl("_3prime|_5prime_1",variable)) %>% 
    group_by(sample) %>% 
    mutate(inclusion_reads = sum(value)) %>% 
    ungroup() %>% 
    dplyr::select(-variable,-value) %>% 
    unique() %>% 
    ggplot(aes(x = disease_group2, y = inclusion_reads * 10^6)) + 
    geom_boxplot() + 
    geom_jitter(height = 0) + 
    facet_wrap(~tissue_clean,nrow = 2) + 
    scale_y_continuous(trans = 'log10') + 
    ggpubr::theme_pubr() +
    ylab("UNC13A cryptic inclusion reads per million")  
```

# Correlation between STMN2 Cryptic PSI and UNC13A TPM

Separated by tissue only in ALS/FTLD-TDP
```{r}

clean_data_table %>% 
    filter(disease_tissue == T) %>% 
  filter(disease_group2 %in% c("FTLD-TDP","ALS-TDP")) %>% 
  ggplot(aes(x = stmn_2_cryptic_psi_leaf, y = UNC13A_TPM)) + 
  geom_point() + 
  stat_cor(size = 8) + 
  geom_smooth(method = lm, se = FALSE,color = "black") +
  xlab("STMN2 Cryptic PSI") +
  ylab("UNC13A TPM") + 
  ggpubr::theme_pubr() + 
  theme(text = element_text(size = 18)) +
  facet_wrap(~tissue_clean,scales = "free_y")
```

No Tissue separation

```{r}
clean_data_table %>% 
    filter(disease_tissue == T) %>% 
  filter(disease_group2 %in% c("FTLD-TDP","ALS-TDP")) %>% 
  ggplot(aes(x = stmn_2_cryptic_psi_leaf, y = UNC13A_TPM)) + 
  geom_point() + 
  stat_cor(size = 8) + 
  geom_smooth(method = lm, se = FALSE,color = "black") +
  xlab("STMN2 Cryptic PSI") +
  ylab("UNC13A TPM") + 
  ggpubr::theme_pubr() + 
  theme(text = element_text(size = 18)) +
  ylim(0,50)
```


```{r}
#tissue separated
clean_data_table %>% 
      filter(stmn_2_cryptic_psi_leaf > 0 ) %>% 
    filter(unc13a_cryptic_leaf_psi > 0 ) %>%
  ggplot(aes(x = unc13a_cryptic_leaf_psi, y = UNC13A_TPM)) + 
  geom_point() + 
  stat_cor(size = 8) + 
  geom_smooth(method = lm, se = FALSE,color = "black") +
  ylab("UNC13A TPM") +
  xlab("UNC13A Cryptic PSI") + 
  ggpubr::theme_pubr() + 
  theme(text = element_text(size = 18)) +
  facet_wrap(~tissue_clean,scales = 'free')

clean_data_table %>% 
      filter(stmn_2_cryptic_psi_leaf > 0 ) %>% 
    filter(unc13a_cryptic_leaf_psi > 0 ) %>%
  ggplot(aes(x = stmn_2_cryptic_psi_leaf, y = UNC13A_TPM)) + 
  geom_point() + 
  stat_cor(label.y = 38,size = 8) + 
  geom_smooth(method = lm, se = FALSE,color = "black") +
  ylab("UNC13A TPM") +
  xlab("STMN2 Cryptic PSI") + 
  ylim(0,40) +
  ggpubr::theme_pubr() + 
  theme(text = element_text(size = 18))

```


# Relationship between UNC13A and STMN2 cryptic PSI

We noted in the cell lines that there was a linear relationship between the amount
of TARDBP KD efficiency and the amount of observed UNC13A cryptic. As a quantitative measure
of TDP-43 proteinopathy does not exist for these patients, no ranked staining, we used the amount of STMN2 
present in a tissue to rank the tissue by the amount of TDP-43 proteinopathy, as we've already shown
you can use that as a measure. Here we show the relationship in samples with 
at least 10 STMN2 annotated junctions and tissues where the PSI of UNC13A cryptic was also detectable, as measured by
STMN2 cryptic occurring in the tissue. 

# Relationship between STMN2 and UNC13A cryptic PSI in patients
```{r}
####scatter plot showing the correlation in non-log space in STMN2 and cryptic PSI####
clean_data_table %>% 
  ggplot(aes(x = stmn_2_cryptic_psi_leaf, y = unc13a_cryptic_leaf_psi)) + 
  geom_point() + 
  stat_cor(size = 8) + 
  geom_smooth(method = lm, se = FALSE,color = "black") +
  xlab("STMN2 Cryptic PSI") +
  ylab("UNC13A Cryptic PSI") + 
  ggpubr::theme_pubr() + 
  theme(text = element_text(size = 18))

clean_data_table %>% 
  filter(disease_tissue == T) %>% 
  filter(disease_group2 %in% c("FTLD-TDP","ALS-TDP")) %>% 
  dplyr::select(sample,tissue_clean,disease_group2,call,stmn_2_cryptic_psi_leaf,unc13a_cryptic_leaf_psi) %>% 
  data.table::melt() %>% 
  mutate(tissue_clean = gsub("_","\n",tissue_clean)) %>% 
  mutate(variable = ifelse(variable == "stmn_2_cryptic_psi_leaf", "STMN2", "UNC13A")) %>% 
  ggbarplot( x = "tissue_clean", 
               y = "value", 
               color = 'variable',
              position = position_dodge(0.8),
              add = c("mean_se","jitter")) +
  ylab("Cryptic PSI event") + 
  facet_wrap(~variable,scales = "free") + 
  scale_color_manual(values = colorblind_pal()(4)[1:3]) +
  theme(legend.position = 'none') + 
  xlab("") +
  theme(text = element_text(size = 18))


```


We can perform this analysis separated by tissue, but low numbers
make the results more complicated to interpret. Additionally, the tissue only
matters in so much as we know that certain tissues in certain diseases
are affected by TDP-43 pathology, whereas others aren't, tissue is not the 
most interesting or important variable, TDP-43 pathology is the question. 


```{r}
clean_data_table %>% 
  filter(disease_tissue == T) %>% 
  filter(disease_group2 %in% c("FTLD-TDP","ALS-TDP")) %>% 
    mutate(call = fct_relevel(call,
                              "C/C", "C/G", "G/G")) %>%
  filter(!grepl("Cord",tissue_clean)) %>% 
    filter(call != "C/G") %>% 
    ggpubr::ggscatter(., 
                      x = "stmn_2_cryptic_psi",
                      y = "unc13a_cryptic_leaf_psi",
                      color = 'call',                      
                      add = "reg.line",
                      ) +
    ylab("UNC13A Cryptic PSI ") + 
    xlab("STMN2 Cryptic PSI ") +
  stat_cor(aes(                      x = stmn_2_cryptic_psi,
                      y = unc13a_cryptic_leaf_psi,
                      color = call ),show.legend = FALSE) + 
  scale_color_manual(values = c("#88CCEE","#105e2a")) +
  theme(text = element_text(size = 18))

```

# Detection rate by genotype

## Barplot of detection by genotype

```{r}
overall_fisher = clean_data_table %>%
    filter(disease_tissue == T) %>% 
  filter(disease_group2 %in% c("FTLD-TDP","ALS-TDP")) %>% 
  mutate(unc13a_detected = unc13a_cryptic_leaf_psi > 0) %>% 
  dplyr::select(participant_id,unc13a_detected,call) %>% 
  unique() %>% 
  group_by(call) %>% 
  mutate(n_sample = n_distinct(participant_id)) %>% 
  mutate(n_sample_detected = sum(unc13a_detected)) %>% 
  dplyr::select(call,n_sample,n_sample_detected) %>% 
  unique() %>% 
  mutate(n_non_detected = n_sample - n_sample_detected) %>% 
  dplyr::select(-n_sample)


over_p = overall_fisher %>% 
  column_to_rownames('call') %>% 
  chisq.test() %>% 
  broom::tidy() %>% 
  .$p.value

overall_fisher %>% 
  mutate(n_sample = n_non_detected + n_sample_detected) %>% 
  mutate(detection_rate = n_sample_detected / n_sample) %>% 
  mutate(detection_name = glue::glue("{call} \n ( {n_sample} )")) %>% 
  ggplot(aes(x = detection_name, y = detection_rate, fill = detection_name)) +
  geom_col(show.legend = F) + 
  ggpubr::theme_pubr() + 
  scale_y_continuous(labels = scales::percent) + 
  ylab("% of TDP-43 Proteionopathy Patients \n UNC13A Cryptic Detected") + 
  theme(text = element_text(size = 18)) + 
  xlab("N individuals") + 
  scale_fill_manual(values = c("#88CCEE","#44AA99","#1B7739")) 

```


Although this difference is not significant, with the Fisher's exact giving
a p-value of `r round(over_p,2)`.


Only looking at disease relevant tissue and in patients 
we see that the detection rate depends on both the level of TPD-43 pathology present, as measured by STMN2 CE expression, 



```{r}
detection_table = clean_data_table %>% 
  filter(disease_tissue == T) %>% 
  filter(disease_group2 %in% c("FTLD-TDP","ALS-TDP")) %>% 
    mutate(call = fct_relevel(call,
                              "C/C", "C/G", "G/G")) %>%
    mutate(stmn2_psi_groups = as.numeric(cut_interval(log10(stmn_2_cryptic_psi), n = 2))) %>%
    mutate(stmn2_psi_groups = ifelse(is.na(stmn2_psi_groups),"  No STMN2",stmn2_psi_groups)) %>%
    mutate(stmn2_psi_groups = case_when(stmn2_psi_groups == 1 ~ " Low STMN2",
                                        stmn2_psi_groups == 2 ~ "High STMN2",
                                        TRUE ~ stmn2_psi_groups)) %>%
  mutate(unc13a_detected = unc13a_cryptic_leaf_psi > 0) %>% 
  group_by(call,unc13a_detected,stmn2_psi_groups) %>% 
  add_count(name = "genotype_detected") %>% 
  dplyr::select(call,unc13a_detected,genotype_detected,stmn2_psi_groups) %>% 
  unique() %>% 
  pivot_wider(names_from = "unc13a_detected",
              values_from = "genotype_detected") %>% 
  dplyr::rename(unc_not_detected = `FALSE`, unc_cryptic_detected = `TRUE`) %>%
  mutate(total_tissue = (unc_not_detected + unc_cryptic_detected)) %>% 
  mutate(detection_rate = unc_cryptic_detected / total_tissue) %>% 
  ungroup() %>% 
  mutate(stmn2_psi_groups = fct_relevel(stmn2_psi_groups, "No STMN2", after = 0)) %>% 
  mutate(detection_name = glue::glue("{call} \n ( {total_tissue} )"))



detection_table %>% 
  ggplot(aes(x = call, y = detection_rate,fill = call)) + 
  geom_col(show.legend = F,position = 'dodge2') + 
  facet_wrap(~stmn2_psi_groups) +
  scale_fill_manual(values = c("#88CCEE","#44AA99","#1B7739")) + 
  scale_y_continuous(lim = c(0,0.5),labels = scales::percent) + 
  ylab("Percent of Samples \n UNC13A Cryptic Detected") + 
  theme(text = element_text(size = 18))  +
  ggpubr::theme_pubr() + 
  geom_text(aes(label = total_tissue,y = 0),vjust = 1,size = 6) + 
  theme(text = element_text(size = 18)) +
  ggpubr::theme_pubr() +
  xlab("N Tissues") 
```

UNC13A cryptic PSI 

```{r}
genotype_comparisons = list(c("C/C", "C/G"), c("C/C", "G/G"), c("C/G", "G/G"))

clean_data_table %>%   
  filter(disease_tissue == T) %>% 
  filter(disease_group2 %in% c("FTLD-TDP","ALS-TDP")) %>% 
    mutate(call = fct_relevel(call,
                              "C/C", "C/G", "G/G")) %>%
  filter(unc13a_cryptic_leaf_psi > 0 ) %>% 
  filter(stmn_2_cryptic_psi_leaf > 0) %>% 
    ggbarplot( x = "call", 
               y = "unc13a_cryptic_leaf_psi", 
               color = 'call',
              position = position_dodge(0.8),
              add = c("mean_se","jitter")) + 
    ylab("UNC13A Cryptic PSI") + 
    scale_color_manual(values = c("#88CCEE","#44AA99","#105e2a")) +
    theme(text = element_text(size = 20)) + 
    stat_compare_means(aes(group = call), label = "p.format") + 
    stat_compare_means(aes(group = call),comparisons = genotype_comparisons,label = "p.signif")
```


```{r}
clean_data_table %>%   
  filter(disease_tissue == T) %>% 
  filter(disease_group2 %in% c("FTLD-TDP","ALS-TDP")) %>% 
    mutate(call = fct_relevel(call,
                              "C/C", "C/G", "G/G")) %>%
    mutate(stmn2_psi_groups = as.numeric(cut_interval(log10(stmn_2_cryptic_psi), n = 2))) %>%
    mutate(stmn2_psi_groups = ifelse(is.na(stmn2_psi_groups),"  No STMN2",stmn2_psi_groups)) %>%
    mutate(stmn2_psi_groups = case_when(stmn2_psi_groups == 1 ~ " Low STMN2",
                                        stmn2_psi_groups == 2 ~ "High STMN2",
                                        TRUE ~ stmn2_psi_groups)) %>%
    filter(unc13a_cryptic_leaf_psi > 0 ) %>% 
    ggbarplot( x = "call", 
               y = "cryptic_psi", 
               color = 'call',
               facet.by = 'stmn2_psi_groups',
              position = position_dodge(0.8),
              add = c("mean_se","jitter")) + 
    ylab("UNC13A Cryptic PSI") + 
    scale_color_manual(values = c("#88CCEE","#44AA99","#105e2a")) +
    theme(text = element_text(size = 20)) + 
    stat_compare_means(aes(group = call), label = "p.format") + 
    stat_compare_means(aes(group = call),comparisons = genotype_comparisons,label = "p.signif")  + 
  xlab("")
```



# Variant allele expression in TDP-43 KD experiments

Across our KD's, we observed a clear allelic bias in the NB cells

```{r}
kd_vafs = fread(file.path(here::here(),"data","all_kds_unc13.snp.out.tsv"))

kd_vafs %>% 
    left_join(rel_rna_cryptic_amount) %>% 
    filter(!is.na(condition)) %>% 
    mutate(VAF = alt_reads / total) %>% 
    filter(condition != "control" ) %>% 
    filter(alt_reads > 5) %>%  
    ggplot(aes(x = stmn_2_cryptic_psi,y = cryptic_psi, fill = -(VAF - 0.5),size = total)) + 
    geom_point(pch = 21)  + 
    coord_fixed() +
  ylim(0,0.8) + 
  xlim(0,0.8) +
  geom_abline() + 
    scale_fill_gradient2()
  
    
kd_vafs %>% 
    left_join(rel_rna_cryptic_amount) %>% 
    filter(!is.na(condition)) %>% 
    filter(condition != "control" ) %>%     
    mutate(VAF = alt_reads / total) %>% 
    filter(source %in% c("sh_dzap","shsy5y_normed","ipsc_normed_ward")) %>% 
    dplyr::select(sample,ref_reads,alt_reads,TARDBP,source,VAF) %>% 
    data.table::melt(id.vars = c("sample","TARDBP",'source','VAF')) %>% 
    mutate(sample = fct_reorder(sample,-TARDBP)) %>% 
    ggplot(aes(x = sample,y = value, fill = variable)) + 
    geom_col(pch = 21, size = 4) +
    coord_flip() 
```

Also look at the coverage in the Liu nuclear facs sorted neurons

```{r}
liu_vafs = fread(file.path(here::here(),"data","liu_facs_neurons_unc13.snp.out.tsv"))
liu_stmn2 = fread(file.path(here::here(),"data","liu_stmn2_and_unc13aaggregated.clean.annotated.bed"))
liu_stmn2[,sample := gsub(".SJ.out","",V4)]
liu_stmn2 = liu_stmn2 %>% 
  unique() %>% 
    pivot_wider(id_cols = 'sample',
                names_from = "V7",
                values_from = 'V5',
                values_fill = 0)
liu_vafs %>% 
    mutate(VAF = alt_reads / total) %>% 
    data.table::melt(id.vars = c("sample",'VAF','total')) %>% 
    mutate(allele = ifelse(variable == "ref_reads", "C","G")) %>% 
    mutate(sample_name = sub("_TDP_.*", "", sample)) %>% 
    mutate(sample_name = gsub("_unsorted", "", sample_name)) %>% 
    mutate(condition = sub(".*_", "", sample)) %>% 
    ggplot(aes(x = condition,y = value, fill = allele)) + 
    geom_col(pch = 21, size = 4) +
    facet_wrap(~sample_name,scales = "free")



liu_stmn2 %>% 
   mutate(stmn2_psi = STMN2_cryptic / (STMN2_cryptic + STMN2_annotated)) %>% 
   mutate(unc13a_psi = (UNC13A_3prime + UNC13A_5prime)/ (UNC13A_annotated + UNC13A_3prime + UNC13A_5prime)) %>% 
   left_join(liu_vafs) %>% 
    mutate(alt_vaf = (alt_reads)/total) %>% 
    mutate(condition = ifelse(grepl("negative",sample),"negative", "positive")) %>% 
             filter(!grepl("unsorted",sample)) %>% 
             
    ggplot(aes(y = unc13a_psi,x = stmn2_psi, fill = alt_vaf)) + 
    geom_point(pch = 21,size = 5) + 
    ggtitle("STMN2 PSI and the VAF of the G allele \n in the Liu Nuclei ") +
  facet_grid(~condition) + 
  scale_fill_viridis_c(option = "plasma") + 
  coord_fixed() + 
  geom_abline()
```

## Variant allele expression in patients

```{r}
nycg_vafs = fread(file.path(here::here(),"data","NYGC_all_samples_UNC13A_snp_coverage.tsv"),fill = T)
nycg_vafs %>% 
    left_join(clean_data_table) %>% 
    filter(call == "C/G") %>% 
    mutate(fraction_risk = alt_reads / total) %>% 
    filter(!is.na(fraction_risk)) %>% 
    filter(stmn_2_cryptic_psi_leaf > 0 ) %>% 
    filter(unc13a_cryptic_leaf_psi > 0 ) %>% 
    ggplot(aes(x = stmn_2_cryptic_psi_leaf, y = unc13a_cryptic_leaf_psi)) +
    geom_point(size = 4, pch = 21, aes(fill = fraction_risk - 0.5)) + 
    xlab("STMN2 Cryptic PSI") +
    ylab("UNC13A Cryptic PSI") +
    geom_abline() + 
    scale_fill_gradient2()
```

