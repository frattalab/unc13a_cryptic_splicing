---
title: "Figures for Paper"
author: "Anna-Leigh Brown"
date: "06/10/2020"
output: 
    html_document:
        code_folding: hide
        toc: true
        toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE)
if (!require("pacman")) install.packages("pacman")
library(pacman)
p_load("data.table",
       "tidyverse",
       "ggplot2",
       "rcompanion",
       "lme4",
       "ggpubr",
       "forcats",
       "scales",
       "here")
```

```{r setup_function, echo=FALSE}
####helper funciton that gets the overall model p-value####
lmp <- function (modelobject) {
    if (class(modelobject) != "lm") stop("Not an object of class 'lm' ")
    f <- summary(modelobject)$fstatistic
    p <- pf(f[1],f[2],f[3],lower.tail=F)
    attributes(p) <- NULL
    return(p)
}

pretty_effect_plot = function(model, p_value_cutoff = 0.05, title = "Model 1"){
  # Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
    p_value = lmp(model)
    r_squared = round(summary(model)$adj.r.squared,3)
    pretty_plot = broom::tidy(model) %>% 
        mutate(p_star = case_when(p.value < 0.001 ~ "***",
                                  p.value < 0.01 ~ "**",
                                  p.value < 0.05 ~ "*",
                                  p.value < 0.1 ~ ".",
                                  p.value > 0.1 ~ "NS")) %>% 
        filter(p.value < p_value_cutoff) %>%
        mutate(term = fct_reorder(term, -abs(estimate))) %>%
        ggplot(aes(x = term, y = estimate,fill = estimate > 0,show.legend = F)) +
        geom_col() +
        coord_flip() +
        ggtitle(title,subtitle = glue::glue("Model p-value: {p_value} \n Adj. R-squared: {r_squared}")) +
        geom_text(aes(x=term, y= -0.01, label=p_star)) 
}
```

# Summary statistics
First let's look at only including tissues with detectable stmn2 or UNC13A CE
```{r}
clean_data_table = fread(file.path(here(),"data","nygc_junction_information.csv"))
clean_data_table = clean_data_table %>%     
    mutate(call = fct_relevel(call,
                              "C/C", "C/G", "G/G")) %>% 
    mutate(number_g_alleles = as.numeric(call) - 1) 

print(glue::glue("Number of unique patients: {clean_data_table[,length(unique(participant_id))]}"))
print(glue::glue("Number of unique tissue samples: {clean_data_table[,length(unique(sample))]}"))
print("Patients Per Disease Category")
clean_data_table[,length(unique(participant_id)),by = disease]
print("Tissues Per Disease Category")
clean_data_table[,length(unique(sample)),by = disease]
print("Number of patients per rs12973192 genotype")
clean_data_table[,length(unique(participant_id)),by = call]
print("Number of tissues per disease")
clean_data_table[,.N,by = c("disease","tissue_clean")]
print("Number of partcipants by mutation and  disease")
clean_data_table[,length(unique(participant_id)),by = c("mutations","disease")]

print(glue::glue("Number of patients per pathology:"))
clean_data_table[,length(unique(participant_id)),by = .(pathology)]
```
# UNC13A cryptic is an event that is specific to TDP-43 proteinopathy

FTLD-non-TDP are those with TAU and FUS aggregates

Non-tdp ALS are those with SOD1 or FUS mutations. The n's are quite low on this 
unfortunately, only 8 ALS with SOD1 and 2 with FUS mutations.  

```{r}
####Inclusion reads by if TDP-potential####
boxplot_table = clean_data_table %>% 
    mutate(disease_group2 = case_when(disease == "Control" ~ "Control",
                                 pathology %in% c("FTD-TDP-A","FTD-TDP-B","FTD-TDP-C") ~ "FTLD-TDP",
                                 pathology %in% c("FTD-TAU","FTD-FUS") ~ "FTLD \n non-TDP",
                                 mutations %in% c("SOD1","FUS") ~ "ALS \n non-TDP",
                                 T ~ "ALS-TDP")) %>% 
    mutate(across(UNC13A_3prime_leaf:UNC13A_annotated_leaf, ~ .x / library_size,.names = "{.col}_library_norm")) %>% 
    filter(!tissue_clean %in% c("Choroid","Liver")) %>% 
    dplyr::select(sample,participant_id,disease_group2,pathology,tissue_clean,contains("_library_norm")) %>% 
    melt() %>% 
    filter(grepl("_3prime|_5prime_",variable)) %>% 
    group_by(sample) %>% 
    mutate(inclusion_reads = sum(value)) %>% 
    ungroup() %>% 
    unique() %>% 
    mutate(junction_name = case_when(variable == "UNC13A_3prime_leaf_library_norm" ~ "  Novel 3'", 
                                 variable == "UNC13A_5prime_1_leaf_library_norm" ~ " Short Novel 5'", 
                                 variable == "UNC13A_5prime_2_leaf_library_norm"~ "Long Novel 5'")) %>% 
    mutate(disease_tissue = case_when((grepl("FTLD",disease_group2) & grepl("Cortex",tissue_clean))  ~ T,
                                      (grepl("ALS",disease_group2) & grepl("Cord|Motor",tissue_clean))  ~ T,
                                      (grepl("Occipital",tissue_clean)) ~ F,
                                      (grepl("Control",disease_group2) & grepl("Cord|Cortex",tissue_clean)) ~ T,
           TRUE ~ F)) %>% 
    mutate(tissue_clean = gsub("_"," ",tissue_clean))


```

Looking at disease tissue only, so just taking the cords in ALS and the 
frontal and temporal cortex of FTLD and then the cord and cortices in Controls.
```{r}

boxplot_table %>% 
  filter(disease_tissue == T) %>% 
  mutate(detected = inclusion_reads > 0) %>% 
  dplyr::select(participant_id,disease_group2,detected) %>% 
  unique() %>% 
  group_by(disease_group2) %>% 
  mutate(n_sample = n_distinct(participant_id)) %>% 
  mutate(n_sample_detected = sum(detected)) %>% 
  select(disease_group2,n_sample,n_sample_detected) %>% 
  unique() %>% 
  mutate(detection_rate = n_sample_detected / n_sample) %>% 
  mutate(disease_group2 = gsub("Control"," Control",disease_group2)) %>% 
  mutate(detection_name = glue::glue("{disease_group2} \n ( {n_sample} )")) %>% 
  ggplot() +
  geom_col(aes(x = detection_name, y = detection_rate)) + 
  ggpubr::theme_pubr() + 
  scale_y_continuous(lim = c(0,1),labels = scales::percent) + 
  ylab("Percent of Patients \n UNC13A Cryptic Detected") + 
  theme(text = element_text(size = 18)) + 
  xlab("N individuals")



boxplot_table %>% 
    filter(disease_tissue == T) %>% 
    group_by(disease_group2) %>% 
    mutate(n_sample = n_distinct(sample)) %>% 
    mutate(disease_group2 = gsub("Control"," Control",disease_group2)) %>% 
    mutate(detection_name = glue::glue("{disease_group2} \n ( {n_sample} )")) %>% 
    ggplot(aes(x = detection_name, y = inclusion_reads * 10^6)) + 
    geom_boxplot() + 
    geom_jitter(height = 0) + 
    scale_y_log10() + 
    ggpubr::theme_pubr() +
    ylab("UNC13A cryptic inclusion \n reads per million") + 
    theme(text = element_text(size = 18)) + 
    xlab("N samples")

####Inclusion reads by if TDP-potential####
boxplot_table %>% 
  filter(disease_group2 %in% c("Control",
                              "FTLD \n non-TDP",
                              "FTLD-TDP")) %>% 
    filter(tissue_clean %in% c("Cerebellum","Frontal Cortex","Temporal Cortex")) %>% 
    ggplot(aes(x = disease_group2, y = value * 10^6)) + 
    geom_boxplot() + 
    geom_jitter(height = 0) + 
    scale_y_log10() + 
    ggpubr::theme_pubr() +
    facet_grid(vars(junction_name),vars(tissue_clean)) + 
    ylab("UNC13A split \n reads per million") +
    theme(text = element_text(size = 18)) + 
    xlab("")

```

Splitting by the type of junction in ALS
```{r}
####Inclusion reads by if TDP-potential####
boxplot_table %>% 
  filter(disease_group2 %in% c("Control",
                              "ALS \n non-TDP",
                              "ALS-TDP")) %>% 
    ggplot(aes(x = disease_group2, y = value * 10^6, 
               fill = junction_name,
               group = junction_name)) + 
    geom_boxplot() + 
    geom_point(pch = 21,position = position_dodge(0.8)) + 
    scale_y_log10() + 
    ggpubr::theme_pubr() +
    facet_wrap(vars(tissue_clean)) + 
    ylab("UNC13A cryptic inclusion \n reads per million") +
    # theme(axis.text.x = element_text(angle = 45,hjust=1)) + 
    scale_fill_manual(values = colorblind_pal()(4)[2:4])

```

```{r}
clean_data_table %>% 
    mutate(disease_group2 = case_when(disease == "Control" ~ "Control",
                                 pathology %in% c("FTD-TDP-A","FTD-TDP-B","FTD-TDP-C") ~ "FTLD-TDP",
                                 pathology %in% c("FTLD-TAU","FTLD-FUS") ~ "FTLD-non-TDP",
                                 mutations %in% c("SOD1","FUS") ~ "ALS \n non-TDP",
                                 T ~ "ALS-TDP")) %>% 
    filter(disease_group2 %in% c("ALS \n non-TDP","ALS-TDP")) %>% 
    mutate(across(UNC13A_3prime_leaf:UNC13A_annotated_leaf, ~ .x / library_size,.names = "{.col}_library_norm")) %>% 
    filter(!tissue_clean %in% c("Choroid","Liver")) %>% 
    dplyr::select(sample,disease_group2,tissue_clean,contains("_library_norm")) %>% 
    melt() %>% 
    filter(grepl("_3prime|_5prime_1",variable)) %>% 
    group_by(sample) %>% 
    mutate(inclusion_reads = sum(value)) %>% 
    ungroup() %>% 
    dplyr::select(-variable,-value) %>% 
    unique() %>% 
    ggplot(aes(x = disease_group2, y = inclusion_reads * 10^6)) + 
    geom_boxplot() + 
    geom_jitter(height = 0) + 
    facet_wrap(~tissue_clean,nrow = 2) + 
    scale_y_continuous(trans = 'log10') + 
    ggpubr::theme_pubr() +
    ylab("UNC13A cryptic inclusion reads per million")  
```

# Relationship between UNC13A and STMN2 cryptic PSI

We noted in the cell lines that there was a linear relationship between the amount
of TARDBP KD efficiency and the amount of observed UNC13A cryptic. As a quantitative measure
of TDP-43 proteinopathy does not exist for these patients, no ranked staining, we used the amount of STMN2 
present in a tissue to rank the tissue by the amount of TDP-43 proteinopathy, as we've already shown
you can use that as a measure. Here we show the relationship in samples with 
at least 10 STMN2 annotated junctions and tissues where the PSI of UNC13A cryptic was also detectable, as measured by
STMN2 cryptic occurring in the tissue. 

## Scatter plot showing the relationship in non-logspace between STMN2 and UNC13A cryptic PSI
```{r}
####scatter plot showing the correlation in non-log space in STMN2 and cryptic PSI####
clean_data_table %>% 
    filter(STMN2_annotated_leaf > 10) %>% 
    filter(stmn_2_cryptic_psi_leaf > 0 ) %>% 
    filter(unc13a_cryptic_leaf_psi > 0 ) %>%
    group_by(call) %>% 
    ggpubr::ggscatter(., 
                      x = "stmn_2_cryptic_psi_leaf",
                      y = "unc13a_cryptic_leaf_psi",
                      add = "reg.line",
                      cor.coef = T) +
    ylab("UNC13A Cryptic PSI ") + 
    xlab("STMN2 Cryptic PSI ") 

####scatter plot showing the correlation in non-log space in STMN2 and cryptic PSI####
clean_data_table %>% 
    filter(STMN2_annotated_leaf > 10) %>% 
    filter(stmn_2_cryptic_psi_leaf > 0 ) %>% 
    filter(unc13a_cryptic_leaf_psi > 0 ) %>%
    mutate(call = fct_relevel(call,"C/C", "C/G", "G/G")) %>%
    group_by(call) %>% 
    ggpubr::ggscatter(., 
                      x = "stmn_2_cryptic_psi_leaf",
                      y = "unc13a_cryptic_leaf_psi",
                      add = "reg.line",
                      color = "call") +
    ylab("UNC13A Cryptic PSI ") + 
    xlab("STMN2 Cryptic PSI ") +
    stat_cor(aes(color = call),show.legend = FALSE) +
    scale_color_manual(values = c("#88CCEE","#44AA99","#105e2a"))
```

You can see a clear relationship, which appears to be modulated by the genotype
of rs12973192. This lead us to see if genotype was actually predictive of the 
amount of UNC13A cryptic psi. Because PSI's tend to be log linear, we chose
to model UNC13A in the log10 + 1 (log10(1) is zero) and we selected for tissues
which show TDP-43 pathology, as we assume this is an event which only begins to
show clear after TDP-43 pathology arises. 

## Scatter plot showing the relationship in log + 1 between STMN2 and UNC13A cryptic PSI

```{r}

clean_data_table %>% 
    mutate(call = fct_relevel(call,
                              "C/C", "C/G", "G/G")) %>%
    filter(STMN2_annotated_leaf > 10) %>% 
    filter(stmn_2_cryptic_psi_leaf > 0 ) %>% 
    filter(unc13a_cryptic_leaf_psi > 0 ) %>% 
    mutate(log10_stmn_2_cryptic_psi_leaf_plusone = log10(stmn_2_cryptic_psi_leaf + 1)) %>% 
    mutate(log10_unc13a_cryptic_leaf_psi_plusone = log10(unc13a_cryptic_leaf_psi + 1)) %>% 
    group_by(call) %>% 
    ggpubr::ggscatter(., 
                      x = "log10_stmn_2_cryptic_psi_leaf_plusone",
                      y = "log10_unc13a_cryptic_leaf_psi_plusone",
                      color = 'call',fill = 'call',                      
                      add = "reg.line") +
    ylab("Log10 UNC13A Cryptic PSI + 1") + 
    xlab("Log10 STMN2 Cryptic PSI + 1 ") +
    scale_color_manual(values = c("#88CCEE","#44AA99","#105e2a")) + 
    scale_fill_manual(values = c("#88CCEE","#44AA99","#105e2a"))


```

We can perform this analysis separated by tissue, but low numbers
make the results more complicated to interpret. Additionally, the tissue only
matters in so much as we know that certain tissues in certain diseases
are affected by TDP-43 pathology, whereas others aren't, tissue is not the 
most interesting or important variable, TDP-43 pathology is the question. 


```{r}
####scatter plot showing the correlation in non-log space in STMN2 and cryptic PSI####
clean_data_table %>% 
    filter(tissue_clean%in% c("Cervical_Spinal_Cord",
                              "Motor_Cortex",
                              "Frontal_Cortex","Temporal_Cortex")) %>% 
    mutate(call = fct_relevel(call,
                              "C/C", "C/G", "G/G")) %>%
    filter(STMN2_annotated_leaf > 10) %>% 
    filter(cryptic_psi > 0 ) %>% 
    filter(stmn_2_cryptic_psi > 0 ) %>% 
    group_by(call) %>% 
    ggpubr::ggscatter(., 
                      x = "stmn_2_cryptic_psi",
                      y = "unc13a_cryptic_leaf_psi",
                      color = 'call',                      
                      add = "reg.line") +
    ylab("UNC13A Cryptic PSI ") + 
    xlab("STMN2 Cryptic PSI ") +
    scale_color_manual(values = c("#88CCEE","#44AA99","#105e2a")) +
    facet_wrap(~tissue_clean)

```

## Modeling UNC13A cryptic using glms and mixed models

This brought us to the idea that we could even potentially model
UNC13A cryptic pathology using genotype and the amount of TDP-43 pathology. 
We've coded the number of G alleles here as a number and are looking into tissue
with TDP-43 pathology(measure with STMN2 cryptic PSI). 

```{r}

new_regress = clean_data_table %>% 
    mutate(call = fct_relevel(call,
                              "C/C", "C/G", "G/G")) %>%
    filter(STMN2_annotated_leaf > 10) %>% 
    filter(stmn_2_cryptic_psi_leaf > 0 ) 


another_model2 = lm(log10(unc13a_cryptic_leaf_psi + 1) ~ 
                   log10(stmn_2_cryptic_psi_leaf + 1) * number_g_alleles + pathology + tissue_clean,
              new_regress)

print(pretty_effect_plot(another_model2,p_value_cutoff = 1,"UNC13A Cryptic PSI"))
```

We find that at a cutoff of 0.01 for significant effects, only the interaction
between the number of G alleles and the amount of STMN2 pathology is predictive
of UNC13A cryptic inclusion. the absolute amount of STMN2 pathology does not
vary between genotypes. 
```{r}
genotype_comparisons = list(c("C/C", "C/G"), c("C/C", "G/G"), c("C/G", "G/G"))

new_regress = new_regress %>% 
    mutate(log10_stmn_2_cryptic_psi_leaf = log10(stmn_2_cryptic_psi_leaf))

ggboxplot(new_regress, x = "call", y = "log10_stmn_2_cryptic_psi_leaf",
          color = "call", palette = "jco")+
  stat_compare_means() +
  stat_compare_means(comparisons = genotype_comparisons)

ggboxplot(new_regress, x = "call", y = "stmn_2_cryptic_psi_leaf",
          color = "call", palette = "jco")+
  stat_compare_means() +
  stat_compare_means(comparisons = genotype_comparisons)

new_regress %>% 
    ggplot() + 
    stat_ecdf(aes(color = call, x = log10_stmn_2_cryptic_psi_leaf_plusone))
```


Now I'm going to test out using mixed models. 

```{r}
library(lme4)
unc_mixed = lmer(log10_unc13a_cryptic_leaf_psi_plusone ~ log10_stmn_2_cryptic_psi_leaf_plusone * number_g_alleles + (1 | pathology), data = new_regress)
summary(unc_mixed)
unc_mixed2 = lmer(log10_unc13a_cryptic_leaf_psi_plusone ~ log10_stmn_2_cryptic_psi_leaf_plusone * number_g_alleles+ (1 | pathology) + (1 | tissue_clean), data = new_regress)
summary(unc_mixed2)

```

This leads us to exploring the affects of UNC13A psi separately for tissues
with 'low' STMN2 and those with 'high' STMN2. This distinction is simply cutting
the distribution of STMN2 psi in half and assigning each tissue to the 'low' or 
'high' group as so
```{r}

```

